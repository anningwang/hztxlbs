<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta charset="utf-8" />
    <title>和仲通讯3D地图</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <link rel="stylesheet" href="/static/ace/assets/css/bootstrap.css" />
    <link rel="stylesheet" href="/static/ace/components/font-awesome/css/font-awesome.css" />
    <link rel="stylesheet" href="/static/components/jquery.gritter/css/jquery.gritter.css" />
    <link rel="stylesheet" href="/static/ace/assets/css/ace.css" class="ace-main-stylesheet" id="main-ace-style" />
    <link rel="stylesheet" href="/static/ace/assets/css/ace-skins.css" />
    <link rel="stylesheet" href="/static/ace/assets/css/ace-rtl.css" />
    <link rel="stylesheet" href="/static/js/jquery.svg.package-1.5.0/jquery.svg.css">
    <link rel="stylesheet" href="/static/ace/components/bootstrap-datetimepicker-master/css/bootstrap-datetimepicker.min.css" />
    <script src="/static/ace/assets/js/ace-extra.js"></script>
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/jquery.svg.package-1.5.0/jquery.svg.js"></script>
    <script src="/static/js/socket.io-1.3.5/socket.io.min.js"></script>
    <script src="/static/js/jquery.mousewheel.js"></script>
    <script src="/static/js/hzlbs/hzlbs.tools.js"></script>
    <script src="/static/js/hzlbs/hzlbs.maps.js"></script>
    <link rel="stylesheet" href="/static/css/hzmap.css" />

    <script src="/static/js/fmap/fengmap.min.js" ></script>
    <style type="text/css">

        html, body
        {
            margin: 0;
            height: 100%;
            overflow: hidden;
            font-family: "Microsoft YaHei",微软雅黑,"MicrosoftJhengHei",华文细黑,STHeiti,MingLiu,sans-serif;
        }

        #map-container {
            position: absolute;
            width:100%;
            height: 100%;
        }

        .promptMsg
        {
            position: absolute;
            left: 2%;
            bottom: 2%;
            background-color: white;
        }

        #prompt {
            margin: 5px 10px;
        }
    </style>

    <link rel="shortcut icon" href="/static/img/favicon.ico" />
    <link rel="bookmark" href="/static/img/favicon.ico" type="image/x-icon" />

</head>

<body class="no-skin" style="min-width: 1200px;">

<div id="navbar" class="navbar navbar-default ace-save-state" style="min-width:190px;">
    <div class="navbar-container ace-save-state" id="navbar-container">
        <!-- #section:basics/sidebar.mobile.toggle -->
        <button type="button" class="navbar-toggle menu-toggler pull-left" id="menu-toggler" data-target="#sidebar"> <span class="sr-only">Toggle sidebar</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
        <!-- /section:basics/sidebar.mobile.toggle -->
        <div class="navbar-header pull-left">
            <a href="http://www.hezhongsz.com" class="navbar-brand" style="padding-top:0; padding-bottom:0;" target="_blank"> <img src="/static/img/logo.jpg" /> </a>
        </div>

        <div class="navbar-buttons navbar-header pull-right" role="navigation">
            <ul class="nav ace-nav">
                <li class="light-blue dropdown-modal"> <a data-toggle="dropdown" href="#" class="dropdown-toggle"> <img class="nav-user-photo" src="/static/ace/assets/avatars/user.jpg" alt="Jason's Photo" /> <span class="user-info"> <small>欢迎登入,</small> 欧先生 </span> <i class="ace-icon fa fa-caret-down"></i> </a>
                    <ul class="user-menu dropdown-menu-right dropdown-menu dropdown-yellow dropdown-caret dropdown-close">
                        <li> <a href="#"> <i class="ace-icon fa fa-cog"></i> Settings</a> </li>
                        <li> <a href="#"> <i class="ace-icon fa fa-user"></i> Profile</a> </li>
                        <li class="divider"></li>
                        <li> <a href="#"> <i class="ace-icon fa fa-power-off"></i> Logout</a> </li>
                    </ul>
                </li>
            </ul>
        </div>

    </div>
</div>

<div class="main-container ace-save-state" style="" id="main-container">
    <script type="text/javascript">
        try {
            ace.settings.loadState('main-container')
        }
        catch(e) {}
    </script>
    <!-- #section:basics/sidebar -->
    <div id="sidebar" class="sidebar responsive ace-save-state">
        <script type="text/javascript">
            try {
                ace.settings.loadState('sidebar')
            }
            catch(e) {}
        </script>
        <div class="sidebar-shortcuts" id="sidebar-shortcuts">
            <div class="sidebar-shortcuts-large" id="sidebar-shortcuts-large">
                <button class="btn btn-success"> <i class="ace-icon fa fa-signal"></i> </button>
                <button class="btn btn-info"> <i class="ace-icon fa fa-pencil"></i> </button>
                <!-- #section:basics/sidebar.layout.shortcuts -->
                <button class="btn btn-warning"> <i class="ace-icon fa fa-users"></i> </button>
                <button class="btn btn-danger"> <i class="ace-icon fa fa-cogs"></i> </button>
                <!-- /section:basics/sidebar.layout.shortcuts -->
            </div>
            <div class="sidebar-shortcuts-mini" id="sidebar-shortcuts-mini"> <span class="btn btn-success"></span> <span class="btn btn-info"></span> <span class="btn btn-warning"></span> <span class="btn btn-danger"></span> </div>
        </div>

        <script src="/static/js/hztx/common_nav.js"></script>
        <ul class="nav nav-list" id="hz_nav"></ul>
        <!-- /.nav-list -->
        <!-- #section:basics/sidebar.layout.minimize -->
        <div class="sidebar-toggle sidebar-collapse" id="sidebar-collapse"> <i id="sidebar-toggle-icon" class="ace-icon fa fa-angle-double-left ace-save-state" data-icon1="ace-icon fa fa-angle-double-left" data-icon2="ace-icon fa fa-angle-double-right"></i> </div>
        <!-- /section:basics/sidebar.layout.minimize -->
    </div>

    <!-- /section:basics/sidebar -->
    <div class="main-content">
        <div class="main-content-inner">
            <!-- #section:basics/content.breadcrumbs -->
            <!-- /section:basics/content.breadcrumbs -->
            <div class="page-content" style="padding-bottom:0;">
                <div class="row">
                    <div id="myCanvas">

                        <div id="map-container"></div>

                        <!-- 坐标转换示例 -->
                        <div class="promptMsg" >
                            <div id="prompt" >点击地图</div>
                        </div>

                    </div>
                </div>

                <!--页脚-->
                <div class="footer">
                    <div class="footer-inner " >
                        <!-- #section:basics/footer -->
                        <div class="footer-content "> <span class="bigger-120"> 衡阳市和仲通讯科技有限公司 &copy; 2016-2018 </span> &nbsp; &nbsp; <span class="action-buttons"> <a href="#"> <i class="ace-icon fa fa-twitter-square light-blue bigger-150"></i> </a> <a href="#"> <i class="ace-icon fa fa-facebook-square text-primary bigger-150"></i> </a> <a href="#"> <i class="ace-icon fa fa-rss-square orange bigger-150"></i> </a> </span> </div>
                        <!-- /section:basics/footer -->
                    </div>
                </div>

            </div><!-- /.page-content -->
        </div>
    </div><!-- /.main-content -->
</div> <!-- /.main-container -->

<script type="text/javascript">

    'use strict';
    var hz_marker = {};     // {userId: {mark: p}
    var im_click = undefined;

    // 定义全局map变量
    var fmapID = 'hztx-hy-f3'; //mapId
    var map;

    window.onload = function() {
        map = new fengmap.FMMap({
            container: document.getElementById('map-container'), //渲染dom

            // 开发者申请应用名称
            appName:'hztxLbs',

            // 开发者申请应用下web服务的key
            key:'0a6829a356caea4bb98fa0f2dea423ed',

            // 主题数据位置
            mapThemeURL : '/static/js/fmap/data/theme',

            // [15, 29], 比例尺级别范围， 16级到23级
            // mapScaleLevelRange: [16, 23],

            // 默认比例尺级别  内部创建的1-29级的比例尺级别
            defaultMapScaleLevel: 22
        });

        // 打开Fengmap服务器的地图数据和主题
        map.openMapById(fmapID);
        map.showCompass = true; // 显示指北针控件
        var ctlOpt1 = new fengmap.controlOptions({
            position: fengmap.controlPositon.LEFT_TOP, // 位置 左上角

            // 位置x,y的偏移量
            offset: {
                x: 20,
                y: 60
            },

            imgURL: '/static/img/',

            // 点击放大、缩小控件回调的方法
            scaleLevelcallback:function(level,result) {
                /*
                console.log("当前级别"+result);
                console.log("最小级别："+map.minScaleLevel,"最大级别："+map.maxScaleLevel);
                */
            }
        });
        // 放大、缩小控件
        // map为FMMap对象，初始化需在地图加载后完成。
        var zoomControl = new fengmap.zoomControl(map, ctlOpt1);
        // console.log('zoomControl', zoomControl);

        // 地图加载完成回掉方法
        map.on('loadComplete',function() {
            var toolControl = new fengmap.toolControl(map, {
                // 初始化2D模式
                init2D: false,

                // 设置为false表示只显示2D,3D切换按钮
                groupsButtonNeeded: false,

                imgURL: '/static/img/',

                // 点击按钮的回调方法,返回type表示按钮类型,value表示对应的功能值
                clickCallBack: function(type, value) {
                    // console.log(type,value);
                }
            });
            //console.log('toolControl', toolControl);


            var socket = io.connect(hz_connStr);
            // 增加定位代码，实时显示人物位置
            socket.on('hz_position', function (msg) {
                console.log('hz_position', msg);
                for(var i = 0; i < msg.length; i++) {
                    var coord = {x: msg[i].x, y: msg[i].y};
                    var fm_coord = hzTransformToFMap(coord);
                    if (msg[i].userId in hz_marker) {
                        hz_marker[msg[i].userId].marker.moveTo({
                            x: fm_coord.x,
                            y: fm_coord.y
                        });
                    } else {
                        var color = 'blue';
                        if (msg[i].userId == '1918E00103AA') color = 'red';
                        var im = addMarker(fm_coord, color);
                        if (im) {
                            hz_marker[msg[i].userId] = {marker: im};
                        }
                    }
                }
            });


        });


        // 地图点击事件
        map.on('mapClickNode',function(event) {
            // 获取坐标信息
            var eventInfo = event.eventInfo.coord;

            // 获取焦点层
            var currentGid = map.focusGroupID;

            var coord = null;
            // 获取x、y坐标
            if (eventInfo) { // pc端
                coord = {
                    x: event.eventInfo.coord.x,
                    y: event.eventInfo.coord.y
                }
            } else { //移动端
                coord = {
                    x: event.mapCoord.x,
                    y: event.mapCoord.y
                }
            }
            console.log('map click, coord=', coord);

            // 获取鼠标点击的坐标
            var domEvent = event.eventInfo.domEvent;
            var _x, _y;

            if (domEvent instanceof MouseEvent) {
                _x = domEvent.clientX;
                _y = domEvent.clientY;
            } else {
                _x = domEvent['changedTouches'][0].clientX;
                _y = domEvent['changedTouches'][0].clientY;
            }

            showPrompt(currentGid, {
                x: _x,
                y: _y,
                z: map.getGroupHeight(currentGid) + map.layerLocalHeight
            });

            // 如果点击的是空白处
            if (!event.nodeType) {
                if (im_click) im_click.visible = false;
            } else {
                if (im_click) {
                    /*
                     im_click.moveTo({
                     x: coord.x,
                     y: coord.y
                     });
                     */

                    im_click.visible = true;
                    im_click.setPosition(coord.x, coord.y);
                } else {
                    im_click = addMarker(coord, 'red');
                }

            }
        });


        // 显示转换坐标信息
        function showPrompt(gid, pt1) {
            var oPrompt = document.getElementById('prompt');
            // 屏幕坐标转换地图坐标
            var pt2 = map.coordScreenToMap(pt1.x, pt1.y, pt1.z);

            // 屏幕到地图坐标可能是没有有意义的一个数字，所以做了范围限制，超出范围则是null！
            if (pt2 != null) {
                //地图坐标转换屏幕坐标
                var pt3 = map.coordMapToScreen(pt2.x, pt2.y, pt2.z);
                oPrompt.innerHTML = '<p>当前楼层(groupId)：groupId=' + gid + '</p><p>楼层高度(height)：height=' + pt1.z + '</p>' + '<p>原始屏幕坐标(point)：x=' + pt1.x + ', y=' + pt1.y + '</p>' + '<p>转换后的地理坐标(mapCoord)：x=' + (pt2.x) + ', y=' + (pt2.y) + '</p>' + '<p>转换后的屏幕坐标(point)：x=' + parseInt(pt3.x) + ', y=' + parseInt(pt3.y) + '</p>';
            } else {
                oPrompt.innerHTML = '<p>当前楼层(groupId)：groupId=' + gid + '</p><p>楼层高度(height)：height=' + pt1.z + '</p>' + '<p>原始屏幕坐标(point)：x=' + pt1.x + ', y=' + pt1.y + '</p>' + '<p>转换后的地理坐标(mapCoord)：超出计算返回</p>' + '<p>转换后的屏幕坐标(point)：无效</p>';
            }
        }

    };

    // 添加Marker
    function addMarker(coord, color) {
        color = color || 'blue';        // 默认blue色
        // 获取焦点层
        var currentGid = map.focusGroupID;
        var group = map.getFMGroup(currentGid);

        if(!group) return;

        // 返回当前层中第一个imageMarkerLayer,如果没有，则自动创建
        var layer = group.getOrCreateLayer('imageMarker');

        // 图标标注对象，默认位置为该楼层中心点
        var im = new fengmap.FMImageMarker({
            x: coord.x,
            y: coord.y,

            // 设置图片路径
            url: color === 'blue' ? '/static/img/blueImageMarker.png' : '/static/img/redImageMarker.png',
            // 设置图片显示尺寸
            size: 32,
            height: 0.5,
            callback: function() {
                // 在图片载入完成后，设置 "一直可见"
                im.alwaysShow();
            }
        });
        layer.addMarker(im);
        console.log('marker:', coord);
        return im;
    }

</script>


<script type="text/javascript">
    if('ontouchstart' in document.documentElement)
        document.write("<script src='/static/ace/components/_mod/jquery.mobile.custom/jquery.mobile.custom.js'>" + "<" + "/script>");
</script>
<script src="/static/ace/components/bootstrap/dist/js/bootstrap.js"></script>
<script src="/static/ace/components/bootstrap-datetimepicker-master/js/bootstrap-datetimepicker.min.js"></script>
<script src="/static/components/jquery.gritter/js/jquery.gritter.js"></script>
<script src="/static/ace/assets/js/src/elements.scroller.js"></script>
<script src="/static/ace/assets/js/src/elements.colorpicker.js"></script>
<script src="/static/ace/assets/js/src/elements.fileinput.js"></script>
<script src="/static/ace/assets/js/src/elements.typeahead.js"></script>
<script src="/static/ace/assets/js/src/elements.wysiwyg.js"></script>
<script src="/static/ace/assets/js/src/elements.spinner.js"></script>
<script src="/static/ace/assets/js/src/elements.treeview.js"></script>
<script src="/static/ace/assets/js/src/elements.wizard.js"></script>
<script src="/static/ace/assets/js/src/elements.aside.js"></script>
<script src="/static/ace/assets/js/src/ace.js"></script>
<script src="/static/ace/assets/js/src/ace.basics.js"></script>
<script src="/static/ace/assets/js/src/ace.scrolltop.js"></script>
<script src="/static/ace/assets/js/src/ace.ajax-content.js"></script>
<script src="/static/ace/assets/js/src/ace.touch-drag.js"></script>
<script src="/static/ace/assets/js/src/ace.sidebar.js"></script>
<script src="/static/ace/assets/js/src/ace.sidebar-scroll-1.js"></script>
<script src="/static/ace/assets/js/src/ace.submenu-hover.js"></script>
<script src="/static/ace/assets/js/src/ace.widget-box.js"></script>
<script src="/static/ace/assets/js/src/ace.settings.js"></script>
<script src="/static/ace/assets/js/src/ace.settings-rtl.js"></script>
<script src="/static/ace/assets/js/src/ace.settings-skin.js"></script>
<script src="/static/ace/assets/js/src/ace.widget-on-reload.js"></script>
<script src="/static/ace/assets/js/src/ace.searchbox-autocomplete.js"></script>
<script src="/static/ace/components/jquery-validation/dist/jquery.validate.js"></script>
</body>

</html>

