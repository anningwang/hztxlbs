<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta charset="utf-8" />
<title>和仲位置服务平台</title>
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />

<!-- bootstrap & fontawesome -->
<link rel="stylesheet" href="../static/ace/assets/css/bootstrap.css" />
<link rel="stylesheet" href="../static/ace/components/font-awesome/css/font-awesome.css" />

<!-- page specific plugin styles -->

<!-- text fonts -->
<link rel="stylesheet" href="../static/ace/assets/css/ace-fonts.css" />

<!-- ace styles -->
<link rel="stylesheet" href="../static/ace/assets/css/ace.css" class="ace-main-stylesheet" id="main-ace-style" />
<link rel="stylesheet" href="../static/ace/assets/css/ace-skins.css" />
<link rel="stylesheet" href="../static/ace/assets/css/ace-rtl.css" />

<!-- svg样式 -->
<link rel="stylesheet" href="/static/js/jquery.svg.package-1.5.0/jquery.svg.css">

<!-- inline styles related to this page -->
<!--时间插件-->

<link rel="stylesheet" href="../static/ace/components/bootstrap-datetimepicker-master/css/bootstrap-datetimepicker.min.css"/>

<!-- ace settings handler -->
<script src="../static/ace/assets/js/ace-extra.js"></script>
<link rel="shortcut icon" href="/static/img/favicon.ico" />
<link rel="bookmark" href="/static/img/favicon.ico" type="image/x-icon" />

<script src="/static/js/jquery.min.js"></script> 
</head>

<body class="no-skin"  style=" min-width:1905px;">
<!-- #section:basics/navbar.layout -->
<div id="navbar" class="navbar navbar-default          ace-save-state" style=" min-width:190px;">
  <div class="navbar-container ace-save-state" id="navbar-container"> 
    <!-- #section:basics/sidebar.mobile.toggle -->
    <button type="button" class="navbar-toggle menu-toggler pull-left" id="menu-toggler" data-target="#sidebar"> <span class="sr-only">Toggle sidebar</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
    
    <!-- /section:basics/sidebar.mobile.toggle -->
    <div class="navbar-header pull-left"> 
      <!-- #section:basics/navbar.layout.brand --> 
      <a href="#" class="navbar-brand" style="padding-top:0; padding-bottom:0;"> <img src="../static/img/logo.jpg" /> </a> 
      
      <!-- /section:basics/navbar.layout.brand --> 
      
      <!-- #section:basics/navbar.toggle --> 
      
      <!-- /section:basics/navbar.toggle --> 
    </div>
    
    <!-- #section:basics/navbar.dropdown -->
    <div class="navbar-buttons navbar-header pull-right" role="navigation">
      <ul class="nav ace-nav">
        
        <!-- #section:basics/navbar.user_menu -->
        <li class="light-blue dropdown-modal"> <a data-toggle="dropdown" href="#" class="dropdown-toggle"> <img class="nav-user-photo" src="../static/ace/assets/avatars/user.jpg" alt="Jason's Photo" /> <span class="user-info"> <small>欢迎登入,</small> 欧先生 </span> <i class="ace-icon fa fa-caret-down"></i> </a>
          <ul class="user-menu dropdown-menu-right dropdown-menu dropdown-yellow dropdown-caret dropdown-close">
            <li> <a href="#"> <i class="ace-icon fa fa-cog"></i> Settings </a> </li>
            <li> <a href="profile.html"> <i class="ace-icon fa fa-user"></i> Profile </a> </li>
            <li class="divider"></li>
            <li> <a href="#"> <i class="ace-icon fa fa-power-off"></i> Logout </a> </li>
          </ul>
        </li>
        
        <!-- /section:basics/navbar.user_menu -->
      </ul>
    </div>
    
    <!-- /section:basics/navbar.dropdown --> 
  </div>
  <!-- /.navbar-container --> 
</div>

<!-- /section:basics/navbar.layout -->
<div class="main-container ace-save-state" style="" id="main-container"> 
  <script type="text/javascript">
				try{ace.settings.loadState('main-container')}catch(e){}
			</script> 
  
  <!-- #section:basics/sidebar -->
  <div id="sidebar" class="sidebar                  responsive                    ace-save-state"> 
    <script type="text/javascript">
					try{ace.settings.loadState('sidebar')}catch(e){}
				</script>
    <div class="sidebar-shortcuts" id="sidebar-shortcuts">
      <div class="sidebar-shortcuts-large" id="sidebar-shortcuts-large">
        <button class="btn btn-success"> <i class="ace-icon fa fa-signal"></i> </button>
        <button class="btn btn-info"> <i class="ace-icon fa fa-pencil"></i> </button>
        
        <!-- #section:basics/sidebar.layout.shortcuts -->
        <button class="btn btn-warning"> <i class="ace-icon fa fa-users"></i> </button>
        <button class="btn btn-danger"> <i class="ace-icon fa fa-cogs"></i> </button>
        
        <!-- /section:basics/sidebar.layout.shortcuts --> 
      </div>
      
      <div class="sidebar-shortcuts-mini" id="sidebar-shortcuts-mini">
						<span class="btn btn-success"></span>

						<span class="btn btn-info"></span>

						<span class="btn btn-warning"></span>

						<span class="btn btn-danger"></span>
					</div> 
    </div>
    <!-- /.sidebar-shortcuts -->
    
            <!--导航JS-->
    <script src="../static/js/hztx/common_nav.js"></script>
    <ul class="nav nav-list" id="hz_nav">
      
    </ul>
    <!-- /.nav-list --> 
    
    <!-- #section:basics/sidebar.layout.minimize -->
    <div class="sidebar-toggle sidebar-collapse" id="sidebar-collapse"> <i id="sidebar-toggle-icon" class="ace-icon fa fa-angle-double-left ace-save-state" data-icon1="ace-icon fa fa-angle-double-left" data-icon2="ace-icon fa fa-angle-double-right"></i> </div>
    
    <!-- /section:basics/sidebar.layout.minimize --> 
  </div>
  
  <!-- /section:basics/sidebar -->
  <div class="main-content">
    <div class="main-content-inner"> 
      <!-- #section:basics/content.breadcrumbs --> 
      
      <!-- /section:basics/content.breadcrumbs -->
      <div class="page-content">
        <div class="page-header">
          <h1>
          地图导航
          <h1>
        </div>
        
        <!-- /section:settings.box -->
        <div class="row">
          <div class="col-sm-12" >
          <!-- PAGE CONTENT BEGINS -->
          
          <style>
        #myCanvas{width: 1690px; height: 860px; position:relative;}
        #floor3 {
			width: 1700px; height: 860px;
            position: absolute;
            overflow: hidden;
            border: 1px solid #b94a48;
			top:0px; left:10px;
			}
        #svg_map{
            width: 1700px;
            height: 860px;
            position:absolute;
            overflow:hidden;
        }
        #svg_path{
            width: 1700px;
            height: 860px;
            position:absolute;
			z-index:10;
        }
		
		#svg_path_history{
            width: 1700px;
            height: 860px;
            position:absolute;
			z-index:11;
        }
		}
		
 
    </style>
          
          <script src="/static/js/jquery.svg.package-1.5.0/jquery.svg.js"></script> 
          <script src="/static/js/socket.io-1.3.5/socket.io.min.js"></script>
          <script src="../static/js/jquery.mousewheel.js"></script> 
          <script>
							 
				
				//localStorage.clear(); // 调试用    清除缓存
				
				
				
					'use strict';
				var hzX = 0, hzY = 0;   // 坐标系原点
				var margin = 0;        //外边距
				var real_loc_to_pix = 0.0891;      //物理单位转像素单位 比例      比例转换计算公式x为传来的数据   x * real_loc_to_pix * zoom
				var map_w = 3477;       /// px
				var map_h = 1769;
				var zoom = 0.486;          /// 地图缩放级别
				var hz_is_navigating = false;      /// 是否曾经设置过导航，或正在导航中
				var HZ_DESTINATION_MEETING_ROOM = 27;     //办公室编号
				var hz_destination = HZ_DESTINATION_MEETING_ROOM;            /// 导航的目的地，默认 第一个 目的地
				var hz_time_id = 0;    //废弃
				var hz_user_id = 0;   //下面的索引   实际函数用0应该是未选择
				var HZ_USER_IDS = ['1918E00103AA', '1918E00103A9'];
				var hz_user_xy = [];   //用户数据  每项为一个用户
				
				var storage = window.localStorage;
				
				
				
				
				if(storage){
					//storage.clear();
					///alert("浏览支持localStorage");
					var _userId = storage['hz_user_id'];
					if(typeof _userId !== 'undefined') {
						hz_user_id = _userId;
					}
					var hz_zoom = storage['hz_zoom'];
					///alert(hz_zoom);
					if(typeof hz_zoom !== 'undefined') {    /// 存在值
						zoom = hz_zoom;
					}
				
					var _dest = parseInt(storage['hz_destination']);
					isNaN(_dest) ? hz_destination = HZ_DESTINATION_MEETING_ROOM : hz_destination = _dest;
				
					///alert(storage['hz_is_navigating'] + "  " + Boolean(storage['hz_is_navigating']));
					hz_is_navigating = Boolean(storage['hz_is_navigating']);
				}else{
					///alert("浏览暂不支持localStorage");
				}
				
				
				$(document).ready(function(){
				
					var namespace = '/HeZhong';
				
					// Connect to the Socket.IO server.
					// The connection URL has the following format:
					//     http[s]://<domain>:<port>[/<namespace>]
					var connStr = location.protocol + '//' + document.domain + ':' + location.port + namespace;
					console.log(connStr);
					var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace);
				
					// Event handler for new connections.
					// The callback function is invoked when a connection with the
					// server is established.
					socket.on('connect', function() {
						socket.emit('hz_event', {data: "I'm connected!"});
						if (hz_is_navigating) {
							$('#go').click();
						}
					});
				
					// Event handler for server sent data.
					// The callback function is invoked whenever the server emits data
					// to the client. The data is then displayed in the "Received"
					// section of the page.
					socket.on('hz_response', function(msg) {
						/// $('#log').append('<br>' + $('<div/>').text('Received #' + msg.count + ': ' + msg.data).html());
					});
				
					socket.on('hz_position', function(msg) {
					 
					  
						
					 
						
						var json = eval(msg); // 数组
						
						
						console.log(json);
						 
				
						
						$.each(json, function (index, item) {//index json 索引   item  为本索引内容
							hz_user_xy[index] = [item['userId'], json[index]['x'], json[index]['y']];
							//把每个人存起来
						});
				
						console.log('json len:', json.length, ' hz_user_xy len:', hz_user_xy.length);
						for (var i = 0; i< json.length; i++) {
							
							 
							
							//zoom:地图缩放级别  
							//   hz_people_goto 把人放到对应位置函数 
							
							hz_people_goto(hz_user_xy[i][1] * real_loc_to_pix * zoom - margin,
									hz_user_xy[i][2] * real_loc_to_pix * zoom - margin, hz_user_xy[i][0]);
						}
					});
						//导航路径
					socket.on('hz_path', function (msg) {
						
						console.log(msg);
						
						console.log(msg.path[0].pt_name)
						
						var pt_path = [];
						pt_path[0] = [msg.x * real_loc_to_pix * zoom, msg.y * real_loc_to_pix * zoom];
						var json = eval(msg.path); // 数组
						$.each(json, function (index, item) {
							// 循环获取数据
							pt_path[index+1] = [parseInt((json[index].x+44/2-2) * zoom), parseInt((json[index].y+44/2-2) * zoom)];
						});
				
						hz_people_go_no_animate(pt_path[pt_path.length-1][0], pt_path[pt_path.length-1][1], 'destination');
						$('#destination').show();
				
						var svg = $('#svg_path').svg('get');
						
				 
						
						for ( var i = 0; i< pt_path.length; i++) {        // 转换坐标
							pt_path[i][0] += hzX;
							pt_path[i][1] += hzY;
						}
						
						svg.clear();
						svg.polyline(pt_path, {fill: 'none', stroke: 'blue', strokeWidth: 4});
					});
				
					$("#go").click(function(){
						$("#go").attr("disabled", true);
						$("#loc").attr("disabled", true);
						$("#userId").attr("disabled", true);
				
						storage['hz_is_navigating'] = true;
						hz_is_navigating = true;
				
						socket.emit('hz_navigating',
								{'location': hz_destination, 'userId':HZ_USER_IDS[hz_user_id-1] });
				
						/*
						// 未做错误处理。后续需要改正
						$.post("/go", {"location": hz_destination, "userId": HZ_USER_IDS[hz_user_id-1]}, function(data, status){
							var pt_path = [];
							var pt = eval(data.points); // 数组
							$.each(pt, function (index, item) {
								hz_people_goto(item['x'] * real_loc_to_pix * zoom + margin, item['y'] * real_loc_to_pix * zoom + margin, item['userId']);
								if (item['userId'] == HZ_USER_IDS[hz_user_id-1]) {
									pt_path[0] = [item['x'] * real_loc_to_pix * zoom, item['y'] * real_loc_to_pix * zoom];
								}
							});
				
							var json = eval(data.path); // 数组
							$.each(json, function (index, item) {
								// 循环获取数据
								pt_path[index+1] = [parseInt((json[index].x+44/2-2) * zoom), parseInt((json[index].y+44/2-2) * zoom)];
							});
				
							hz_people_go_no_animate(pt_path[pt_path.length-1][0], pt_path[pt_path.length-1][1], 'destination');
							$('#destination').show();
				
							var svg = $('#svg_path').svg('get');
							svg.clear();
							for ( var i = 0; i< pt_path.length; i++) {        // 转换坐标
								pt_path[i][0] += hzX;
								pt_path[i][1] += hzY;
							}
				
							svg.polyline(pt_path, {fill: 'none', stroke: 'blue', strokeWidth: 4});
				
							storage['hz_is_navigating'] = true;
							hz_is_navigating = true;
						});
						*/
					 });
				
					/// 停止导航
					$("#stop").click(function () {
					   navgationStop();
					});
						
					//停止导航函数
					
					function navgationStop(){
						 if(hz_is_navigating){
							hz_clear_path();
							storage.removeItem('hz_is_navigating');
							hz_is_navigating = false;
							$("#go").attr("disabled", false);
							$("#loc").attr("disabled", false);
							$("#userId").attr("disabled", false);
							$("#destination").hide();
				
							socket.emit('hz_stop_navigating');
						}	
					}
				
					
				
					$("#zoomOut").click(function () {
						zoom = parseFloat(zoom) + 0.05;
						storage['hz_zoom'] = zoom;
						hz_map_zoom(margin, margin, map_h * zoom, map_w * zoom);
				
						hz_change_item_in_map();
						/*
						for (var i = 0; i< hz_user_xy.length; i++) {
							hz_people_go_no_animate(hz_user_xy[i][1] * real_loc_to_pix * zoom - margin,
									hz_user_xy[i][2] * real_loc_to_pix * zoom - margin, hz_user_xy[i][0]);
						}
				
						if (hz_is_navigating) {
							hz_clear_path();
							$("#go").click();
						}
				
						var svg = $('#svg_map').svg('get');
						svg.clear();
						drawInitial(svg);
						*/
					});
				
					$("#zoomIn").click(function () {
						zoom = parseFloat(zoom) - 0.05;
						storage['hz_zoom'] = zoom;
						hz_map_zoom(margin, margin, map_h * zoom, map_w * zoom);
				
						hz_change_item_in_map();
						/*
						for (var i = 0; i< hz_user_xy.length; i++) {
							hz_people_go_no_animate(hz_user_xy[i][1] * real_loc_to_pix * zoom - margin,
									hz_user_xy[i][2] * real_loc_to_pix * zoom - margin, hz_user_xy[i][0]);
						}
				
						if (hz_is_navigating) {
							hz_clear_path();
							$("#go").click();
						}
				
						var svg = $('#svg_map').svg('get');
						svg.clear();
						drawInitial(svg);
						*/
					});
				/*
					$(".btnGetLocation").click(function(){
						$.post("/get_location", {"userId": "1918E00103AA"}, function(data, status){
							var json = eval(data); // 数组
							$.each(json, function (index, item) {
								hz_user_xy[index] = [item['userId'], json[index]['x'], json[index]['y']];
							});
				
							for (var i = 0; i< hz_user_xy.length; i++) {
								hz_people_go_no_animate(hz_user_xy[i][1] * real_loc_to_pix * zoom - margin,
										hz_user_xy[i][2] * real_loc_to_pix * zoom - margin, hz_user_xy[i][0]);
							}
						});
					});
				*/
					/// 调整地图大小
					hz_map_zoom(margin, margin, map_h * zoom, map_w * zoom);
				
					if(hz_user_id != 0) {       /// 设置选择用户（标签）图片
						$('#'+ HZ_USER_IDS[hz_user_id-1]).attr('src', '/static/img/peoplesel.png');
					}
					/// 调整用户、标签位置
					///$('.btnGetLocation').click();
				
				
					
					
					$("#loc").val(parseInt(hz_destination));
					$("#userId").val(parseInt(hz_user_id));
					$("#go").attr("disabled", hz_user_id == '0');
					$("#loc").attr("disabled", hz_user_id == '0');
					$('#destination').hide();
				
				});
				
					function hz_change_item_in_map() {
						for (var i = 0; i< hz_user_xy.length; i++) {
							hz_people_go_no_animate(hz_user_xy[i][1] * real_loc_to_pix * zoom - margin,
									hz_user_xy[i][2] * real_loc_to_pix * zoom - margin, hz_user_xy[i][0]);
						}
				
						if (hz_is_navigating) {
							hz_clear_path();
							$("#go").click();
						}
				
						var svg = $('#svg_map').svg('get');
						svg.clear();
						drawInitial(svg);
					}
				
				function hz_map_zoom(left, top, height, width, isAnimate) {
					isAnimate = isAnimate || true;     // 默认参数为true，执行动画
					$("#map").stop(true, true).animate({
						left:left + hzX,
						top:top + hzY,
						height:height,
						width:width
					});
					if (!isAnimate) {
						$('#map').stop(true, true);
				   }
				}
				//(用户)人位置函数
				function hz_people_goto(x, y, people) {
				 
					
					people = people || '1918E00103AA';      // 设置默认参数
					
				 
					
					/// 24, 45是定位图标的 针尖 位置。显示图片时，是以图片左上角为参考坐标。故需要对坐标进行偏移。
					$("#"+people).stop(true, true).animate({
						left: (hzX + x - 24),
						top: (hzY + y - 45)
					});
				}
				
				function hz_people_go_no_animate(x, y, people) {
				 
					
					people = people || '1918E00103AA';      // 设置默认参数
					
					
					/// 24, 45 是定位图标的 针尖 位置。显示图片时，是以图片左上角为参考坐标。故需要对坐标进行偏移。
					$("#"+people).animate({
						left: hzX + x - 24,
						top: hzY + y - 45
					}).stop(true, true);
				}
				
				function hz_clear_path() {
					$('#svg_path').svg('get').clear();
				}
				
				$(function() {
					$('#svg_map').svg({onLoad: drawInitial});
					$('#svg_path').svg({onLoad: drawIniPath()});
				
					// pan map
					var hzStillDown = false;
					var hzCanvas = $("#floor3");
					var hzOriginalX = 0,  hzOriginalY = 0;
					hzCanvas.mousedown(function(event){
						// console.log('div floor3 was clicked!' + event.pageX + ',' + event.pageY);
						// console.log('offset:(' + event.offsetX + ',' + event.offsetY + ')');
						hzStillDown = true;
						hzOriginalX = event.offsetX;
						hzOriginalY = event.offsetY;
						$(this).css('cursor', 'move');
					});
				
					///var hzCoords = [];
					hzCanvas.mousemove(function(e){
						///if(!hzStillDown) return;
						// console.log("moving");
						///hzCoords.push({x: e.offsetX, y: e.offsetY});
						// and/or do whatever you need with the coordinates
					});
				
					hzCanvas.mouseup(function(e){
						if (!hzStillDown) return;
						hzStillDown = false;
						$(this).css('cursor', 'default');
						if (e.offsetX - hzOriginalX == 0 && e.offsetY - hzOriginalY == 0) return;
						hzX += e.offsetX - hzOriginalX;
						hzY += e.offsetY - hzOriginalY;
						$('#map').animate({
							left: hzX,
							top: hzY
						});
						hz_change_item_in_map();
						svg_path_move();
						/*
						var svg = $('#svg_map').svg('get');
						svg.clear();
						drawInitial(svg);
						*/
					});
				});
				
				function svg_path_move(){
						$('#svg_path_history').animate({
							left: hzX,
							top: hzY
						});
					
				}
				
				
				function drawIniPath() {
				}
				
				function drawInitial(svg) {
				/*    var x_meeting_room = 1420;
					var y_meeting_room = 3000;
					svg.text(parseInt(x_meeting_room*real_loc_to_pix*zoom)+hzX, parseInt(y_meeting_room*real_loc_to_pix*zoom)+hzY, '会议室');*/
					transformDemo(svg);
				}
				
				function transformDemo(svg) {
					var x_meeting_room = 2067;
					var y_meeting_room = 3563;
				
					svg.describe('Example Skew - Show effects of skewX and skewY');
					var str3 = 'translate(' +  parseInt(x_meeting_room*real_loc_to_pix*zoom+hzX) + ',' + parseInt(y_meeting_room*real_loc_to_pix*zoom+hzY) + ')';
					var g1 = svg.group({transform: str3});
					svg.text(g1, 0, 0, '会议室',{fontSize: 20, fontFamily: 'Verdana', fill: 'blue'});
				
					var vice_general_office_x = 2067;
					var vice_general_office_Y = 8981;
					var str3 = 'translate(' +  parseInt(vice_general_office_x*real_loc_to_pix*zoom+hzX) + ',' + parseInt(vice_general_office_Y*real_loc_to_pix*zoom+hzY) + ')';
					var g1 = svg.group({transform: str3});
					svg.text(g1, 0, 0, '副总办公室',{fontSize: 20, fontFamily: 'Verdana', fill: 'blue'});
				
					var president_office_x = 2067;
					var president_office_y = 15609;
					var str3 = 'translate(' +  parseInt(president_office_x*real_loc_to_pix*zoom+hzX) + ',' + parseInt(president_office_y*real_loc_to_pix*zoom+hzY) + ')';
					var g1 = svg.group({transform: str3});
					svg.text(g1, 0, 0, '总裁室',{fontSize: 20, fontFamily: 'Verdana', fill: 'blue'});
				 
					var warehouse1_x = 7947;
					var warehouse1_y = 15609;
					var str3 = 'translate(' +  parseInt(warehouse1_x*real_loc_to_pix*zoom+hzX) + ',' + parseInt(warehouse1_y*real_loc_to_pix*zoom+hzY) + ')';
					var g1 = svg.group({transform: str3});
					svg.text(g1, 0, 0, '仓库1',{fontSize: 20, fontFamily: 'Verdana', fill: 'blue'});
				
					var warehouse2_x = 12046;
					var warehouse2_y = 15609;
					var str3 = 'translate(' +  parseInt(warehouse2_x*real_loc_to_pix*zoom+hzX) + ',' + parseInt(warehouse2_y*real_loc_to_pix*zoom+hzY) + ')';
					var g1 = svg.group({transform: str3});
					svg.text(g1, 0, 0, '仓库2',{fontSize: 20, fontFamily: 'Verdana', fill: 'blue'})
				 
					var log_conference_room_x = 31148;
					var log_conference_room_y = 14433;
					var str3 = 'translate(' +  parseInt(log_conference_room_x*real_loc_to_pix*zoom+hzX) + ',' + parseInt(log_conference_room_y*real_loc_to_pix*zoom+hzY) + ')';
					var g1 = svg.group({transform: str3});
					svg.text(g1, 0, 0, '大会议室',{fontSize: 20, fontFamily: 'Verdana', fill: 'blue'})
					
					var wisdom_medical_treatment_x = 34569;
					var wisdom_medical_treatment_y = 9587;
					var str3 = 'translate(' +  parseInt(wisdom_medical_treatment_x*real_loc_to_pix*zoom+hzX) + ',' + parseInt(wisdom_medical_treatment_y*real_loc_to_pix*zoom+hzY) + ')';
					var g1 = svg.group({transform: str3});
					svg.text(g1, 0, 0, '智慧医疗',{fontSize: 16, fontFamily: 'Verdana', fill: 'blue'})
				
					var wisdom_park_x = 34309;
					var wisdom_park_y = 6486;
					var str3 = 'translate(' +  parseInt(wisdom_park_x*real_loc_to_pix*zoom+hzX) + ',' + parseInt(wisdom_park_y*real_loc_to_pix*zoom+hzY) + ')';
					var g1 = svg.group({transform: str3});
					svg.text(g1, 0, 0, '智慧园区',{fontSize: 16, fontFamily: 'Verdana', fill: 'blue'})
					
					var gym_x = 33678;
					var gym_y = 3101;
					var str3 = 'translate(' +  parseInt(gym_x*real_loc_to_pix*zoom+hzX) + ',' + parseInt(gym_y*real_loc_to_pix*zoom+hzY) + ')';
					var g1 = svg.group({transform: str3});
					svg.text(g1, 0, 0, '健身房',{fontSize: 16, fontFamily: 'Verdana', fill: 'blue'})
					
					
					var intelligent_security_x = 31000;
					var intelligent_security_y = 3101;
					var str3 = 'translate(' +  parseInt(intelligent_security_x*real_loc_to_pix*zoom+hzX) + ',' + parseInt(intelligent_security_y*real_loc_to_pix*zoom+hzY) + ')';
					var g1 = svg.group({transform: str3});
					svg.text(g1, 0, 0, '智慧安防',{fontSize: 16, fontFamily: 'Verdana', fill: 'blue'})
					
					var intelligent_fire_protection_x = 28403;
					var intelligent_fire_protection_y = 3101;
					var str3 = 'translate(' +  parseInt(intelligent_fire_protection_x*real_loc_to_pix*zoom+hzX) + ',' + parseInt(intelligent_fire_protection_y*real_loc_to_pix*zoom+hzY) + ')';
					var g1 = svg.group({transform: str3});
					svg.text(g1, 0, 0, '智慧消防',{fontSize: 16, fontFamily: 'Verdana', fill: 'blue'})
					
					var beidou_xihe_x = 25588;
					var beidou_xihe_y = 3101;
					var str3 = 'translate(' +  parseInt(beidou_xihe_x*real_loc_to_pix*zoom+hzX) + ',' + parseInt(beidou_xihe_y*real_loc_to_pix*zoom+hzY) + ')';
					var g1 = svg.group({transform: str3});
					svg.text(g1, 0, 0, '北斗羲和',{fontSize: 16, fontFamily: 'Verdana', fill: 'blue'})
					
					
					var computer_room_x = 19244;
					var computer_room_y = 4775;
					var str3 = 'translate(' +  parseInt(computer_room_x*real_loc_to_pix*zoom+hzX) + ',' + parseInt(computer_room_y*real_loc_to_pix*zoom+hzY) + ')';
					var g1 = svg.group({transform: str3});
					svg.text(g1, 0, 0, '机房',{fontSize: 20, fontFamily: 'Verdana', fill: 'blue'})	
					
					var reception_x = 19244;
					var reception_y = 7456;
					var str3 = 'translate(' +  parseInt(reception_x*real_loc_to_pix*zoom+hzX) + ',' + parseInt(reception_y*real_loc_to_pix*zoom+hzY) + ')';
					var g1 = svg.group({transform: str3});
					svg.text(g1, 0, 0, '前台',{fontSize: 20, fontFamily: 'Verdana', fill: 'blue'})	
				
				
				}
				
				var colours = ['purple', 'red', 'orange', 'yellow', 'lime', 'green', 'blue', 'navy', 'black'];
				
				function random(range) {
					return Math.floor(Math.random() * range);
				}
				
				 /*
				function getPos()
				{
					if (hz_is_navigating) {
						$("#go").click();
					} else {
						///$(".btnGetLocation").click();
					}
				
					for (var p in hz_user_xy) {
						if(hz_user_xy.hasOwnProperty(p)) {
							hz_people_goto(hz_user_xy[p][0] * real_loc_to_pix * zoom - margin,
									hz_user_xy[p][1] * real_loc_to_pix * zoom - margin, p );
						}
					}
				}
				*/
				
				/// hz_time_id = window.setInterval("getPos()", 1000);
				
				function selectLocation(str){
					hz_destination = parseInt(str);
					storage['hz_destination'] = hz_destination;
				}
				
				function selectUser(str){
					if(hz_user_id != 0) {       /// 还原用户（标签）图片为“未选中”状态
						$('#'+ HZ_USER_IDS[hz_user_id-1]).attr('src', '/static/img/people.png');
					}
					hz_user_id = str;
					storage['hz_user_id'] = hz_user_id;
					if(hz_user_id != 0) {       /// 设置选择用户（标签）图片
						$('#'+ HZ_USER_IDS[hz_user_id-1]).attr('src', '/static/img/peoplesel.png');
					}
				
					$("#go").attr("disabled", hz_user_id == '0');
					$("#loc").attr("disabled", hz_user_id == '0');
				}
				
				 
          </script>   
		 <script>
          	//iii
			//鼠标滚轮缩放svg图
			$(function(){
				 
				 //localStorage.clear();
				
				 
				$('#svg_map').ready(
					function(){
						
						//获取svg图对象
						var mapSign = $('#map');
						//设置缩放速度   比例缩放
						var zoomSpeed = 0.05;
						
		 
						// using the event helper
						$('#svg_map').mousewheel(function(event, delta, deltaX, deltaY) {
						
						 		//svg图的最小 最大  X和Y
								var mapMinX,mapMaxX,mapMinY,mapMaxY;
								
								var mapOffset = mapSign.offset();
								
								var mapOuterWidth = mapSign.outerWidth();
								var mapOuterHeight = mapSign.outerHeight();
								
								mapMinX = mapOffset.left;
								mapMaxX = mapOffset.left + mapOuterWidth;
								mapMinY = mapOffset.top;
								mapMaxY = mapOffset.top + mapOuterHeight;
								
								
								
								
							
							
							if(event.pageX > mapMinX && event.pageX < mapMaxX && event.pageY > mapMinY && event.pageY <  mapMaxY){

								
								  /*取消默认事件*/
								  event.preventDefault()
								  /*计算速度*/
 						 			
								  
								  var mapHeight, mapWidth, mapTopBorder , mapLeftBorder ,mapTop, mapLeft , speedTop ,speedLeft;
								  /*#map 的基本参数*/
								  mapHeight = mapSign.height();
								  mapWidth = mapSign.width();
								  
								  mapTopBorder = parseInt(mapSign.css('border-top-width'));
								  mapLeftBorder = parseInt(mapSign.css('border-left-width'));
								  
								  mapTop = parseInt(mapSign.css('top'));
								  mapLeft = parseInt(mapSign.css('left'));
								  
								  
								  
								  /*计算缩放速度  单独的top  或  left*/
								  
								  if(delta == 1){
								  	  speedTop =  parseInt(zoomSpeed * mapHeight);
									  console.log ('speedTop',speedTop); 
									  speedLeft =  parseInt(zoomSpeed * mapWidth);
								  }else{
								  	  speedTop =  -parseInt(zoomSpeed * mapHeight);
									  speedLeft = -parseInt(zoomSpeed * mapWidth);
								  }
								  
								 
								/*更改后的高*/
								var resultHeight = mapHeight + (speedTop * 2); 
								var resultWidth = mapWidth + (speedLeft * 2);
								
								
								/*鼠标在图内距离*/
								var currentMouseTop = event.pageY - mapMinY - mapTopBorder;
								var currentMouseLeft = event.pageX - mapMinX - mapLeftBorder;
								/*缩放后再图内的距离*/
								var mouseTop = Math.round(currentMouseTop - (currentMouseTop / mapHeight * resultHeight));
								var mouseLeft = Math.round(currentMouseLeft - (currentMouseLeft / mapWidth * resultWidth));
								 
								 
		
 
 								/*计算svg偏离距离*/
								/*svg图的left*/
 
									
										
								hzY = mapTop + mouseTop  ;
					 			hzX =  mapLeft + mouseLeft ;
									
					 				
								/*保存缩放比例*/
							 	zoom = resultWidth / map_w;
								storage['hz_zoom'] = zoom;
									
									
									
 
        						  hz_map_zoom(margin, margin, resultHeight , resultWidth);
 		  						  hz_change_item_in_map();
								  
								  
								  $('#svg_path_history').svg();
									var svg = $('#svg_path_history').svg('get');
									//svg.clear();
									 
									svg.clear();
								  
								  
								 /*计算图片相对父元素位置*/
 								  
							}
  							 
						});
 
					}
				);	
			})
			
          </script>
          <script>

	//iii	
	 $(function(){
	 		
		 
		
			/**
			 * 向服务器发送 Ajax 请求，查询相关数据, POST方式
			 * @param url       请求 url
			 * @param txData    请求 参数，具体参数含义，见对应接口说明                  
			 
			 数据格式
			 
			 url = '/lbs/get_history_location';  访问地址 
            txData = {
                "userId": ["1918E00103AA"],     // "userId": ["all"] for all users
                "datetimeFrom": "2017-09-17 11:17:35",          // 按照时间段查询
                "datetimeTo": "2017-09-23 11:17:35",
                "compress": false       // 是否压缩，压缩的含义是，服务器会根据特定策略返回部分路径坐标。 保留参数
            };
			 */
			
			function ajaxRequest(url, txData) { 
				//接受到的数据 
				var ajaxData;
				$.ajax({
					url: url,
					async: false,
					type: 'POST',
					data: {data: JSON.stringify(txData)}
				}).done(function(data) {
					console.log('接口调用成功');
					console.log('receive:', data);
					 
					ajaxData = data;
					
					
					 
				}).fail(function(jqXHR, textStatus, errorThrown) {
					console.log('接口调用失败');
					ajaxData = false;
					
				 
				});
				 return ajaxData;
				 
			}
			
			//历史轨迹查询按钮绑定
			
			$('#historical-trajectory-query-button').click(function(){
				
				historicalTrajectory();
			});
			
			
			//历史轨迹查询函数

			function historicalTrajectory(){
				
				//查询需要的参数
				var userName,startTime,endTime;
				//数据发送地址
				var url;
				var data;  //后台传过来的数据
 				//获得数据并测试是否合法 
				userName = $('#historical-trajectory-user-name').val();
				
		 
				
				if(userName == 0){
					alert('请选择查询用户');
					return;
				}
				
			 
				startTime = $('#historical-trajectory-start-time').val();
			 
				if(startTime == ''){
					alert('请选择起始查询时间');
					return;
				}
			 
				endTime = $('#historical-trajectory-end-time').val();
				
				if(endTime == ''){
					alert('请选择截止查询时间');
					return;
				}				
			 
				
				url = '/lbs/get_history_location';
				
				var txData = {
					"userId": [userName],     // "userId": ["all"] for all users
					"datetimeFrom": startTime,          // 按照时间段查询
					"datetimeTo": endTime,
					"compress": false       // 是否压缩，压缩的含义是，服务器会根据特定策略返回部分路径坐标。 保留参数
				};	
				
				
				data = ajaxRequest(url, txData);
				
				if(data == false){
					alert('连接错误');
					return;
				}
	
 
			 	
				//后台传来的数据有问题    对象键  不能数字开头 
				
				//临时数据 

	        	var temporaryData = data.data[userName];
				console.log(temporaryData);
		
				
				console.log('xinew:',temporaryData);
				//没有数据的情况
				if(temporaryData == undefined){
					alert('该时间段没有数据');
					return;		
				} 
 
		 
				//曲线位置存储
				var points = [];
				/*曲线样式数据*/
 

				var temporaryDataLength = temporaryData.length;
				
				

		 	    for(var temporaryI = 0 ; temporaryI<temporaryDataLength;temporaryI++){
				     var temporaryDataFirst = temporaryData[temporaryI];
					 
					 var temporaryArr = [];
					 var temporaryArrX,temporaryArrY;
					 
					 temporaryArrX = unitConversion(temporaryDataFirst.x);
					 temporaryArrY = unitConversion(temporaryDataFirst.y);
					 
					 
					 temporaryArr.push(temporaryArrX);
					 temporaryArr.push(temporaryArrY);
					 
					 points.push(temporaryArr);
					 
					 temporaryArr = null;
					 temporaryArrX = null;
					 temporaryArrY = null;
					  
				}
				
						$('#svg_path_history').svg();
					var svg = $('#svg_path_history').svg('get');
					//svg.clear();
					 
					svg.clear();
 					$('#svg_path_history').css({top:hzY,left:hzX});
					 //曲线
					svg.polyline(points,{
						fill: 'none',
						stroke: 'blue',
						strokeWidth: 1
					});
				 	svg.text(points[0][0],points[0][1],'起',{fontSize: 16, fontFamily: 'Verdana',fill:'red'})
					svg.text(points[temporaryDataLength-1][0],points[temporaryDataLength-1][1],'终',{fontSize: 16, fontFamily: 'Verdana',fill:'red'})
				
 
			 
			 	
			 
			 	
				//判断是否出现连接错误
				

			 	
					
			}
			
			
			//单位转换
			function unitConversion(number){
				return Math.round(number * real_loc_to_pix * zoom);
			}
			
			
			
	
			
			
			//以下为时间日历插件
			
				 
			
		 	     
 	 			 $('.date-timepicker').datetimepicker({
				 //ormat: 'MM/DD/YYYY h:mm:ss A',//use this option to display seconds
					  language: 'zh-CN',
					 format: 'yyyy-mm-dd hh:ii:ss',
					 autoclose: true,
					 
				});
				
				
 
		 

			
			
	 })


</script>
	<!--内容-->
	<div class='row'>
          <div class="row">
              
              
              
                  <div class="col-xs-2">
   
                  		<div class="col-xs-4">
                         <label class="control-label no-padding-right pull-right">历史轨迹:</label>
           				</div> 
                        <div class="col-sm-8">
                          <select id="historical-trajectory-user-name" >
                            <option value="0">请选择用户开启导航</option>
                            <option value="1918E00103AA">1918E00103AA</option>
                            <option value="1918E00103A9">1918E00103A9</option>
                          </select>
                    	</div>
        
                  </div>
                   
              
              
                 <div class="col-xs-5">
                  		<div class="col-xs-2">
                         <label class="control-label no-padding-right pull-right">查询时间:</label>
    					</div>	        
	                    
                        
                        <div class="col-xs-7">
                        
                            <span class="input-icon">
                                <input type="text" id="historical-trajectory-start-time" class="date-timepicker"  placeholder="查询起始时间" style="width:178px;"/>                            
                            </span>
    
                            <span class="input-icon input-icon-right">
                                <input type="text" id="historical-trajectory-end-time" class="date-timepicker" placeholder="查询截止时间" style="width:178px;"/>         
                            </span>

                	  	</div>
                        <div class="col-xs-2">
                            <button class="btn btn-info btn-sm" id="historical-trajectory-query-button">查询</button>
                        </div>
                  </div>
              	
              </div>
              <div class="hr hr-24"></div>  
          <div class="row">
          	<div id="myCanvas">
              <div id="floor3" style="background:url(/static/img/cross.gif) fixed"> <img src="/static/img/floor3.svg" width="1706" height="867.9" style="position:absolute" id="map" >
              <div id="svg_map">
                 <div id="svg_path"></div>
                 <div id="svg_path_history"></div>
                <img src="/static/img/people.png" style="position:absolute" id="1918E00103AA" title="1918E00103AA"> <img src="/static/img/people.png" style="position:absolute" id="1918E00103A9" title="1918E00103A9"> <img src="/static/img/dest.png" style="position:absolute" id="destination" title="终点"> 
                </div>
            </div>
          </div>
   		  </div>	
    </div>
          <!--页脚-->
          
          <div class="footer">
            <div class="footer-inner " > 
              <!-- #section:basics/footer -->
              <div class="footer-content "  style=" min-width:1713px;" > <span class="bigger-120"> 衡阳市和仲通讯科技有限公司 &copy; 2016-2018 </span> &nbsp; &nbsp; <span class="action-buttons"> <a href="#"> <i class="ace-icon fa fa-twitter-square light-blue bigger-150"></i> </a> <a href="#"> <i class="ace-icon fa fa-facebook-square text-primary bigger-150"></i> </a> <a href="#"> <i class="ace-icon fa fa-rss-square orange bigger-150"></i> </a> </span> </div>
              
              <!-- /section:basics/footer --> 
            </div>
          </div>
          
          <!-- PAGE CONTENT ENDS --> 
        </div>
        <!-- /.col --> 
      </div>
      <!-- /.row --> 
    </div>
    <!-- /.page-content --> 
  </div>
</div>
<!-- /.main-content --> 

<!--<a href="#" id="btn-scroll-up" class="btn-scroll-up btn btn-sm btn-inverse">
				<i class="ace-icon fa fa-angle-double-up icon-only bigger-110"></i>
			</a>-->
</div>
<!-- /.main-container --> 

<!-- basic scripts --> 

<script type="text/javascript">
			if('ontouchstart' in document.documentElement) document.write("<script src='../static/ace/components/_mod/jquery.mobile.custom/jquery.mobile.custom.js'>"+"<"+"/script>");
		</script> 
<script src="../static/ace/components/bootstrap/dist/js/bootstrap.js"></script> 

<!--时间控制插件--> 

<script src="../static/ace/components/bootstrap-datetimepicker-master/js/bootstrap-datetimepicker.min.js"></script> 

<!-- ace scripts --> 
<script src="../static/ace/assets/js/src/elements.scroller.js"></script> 
<script src="../static/ace/assets/js/src/elements.colorpicker.js"></script> 
<script src="../static/ace/assets/js/src/elements.fileinput.js"></script> 
<script src="../static/ace/assets/js/src/elements.typeahead.js"></script> 
<script src="../static/ace/assets/js/src/elements.wysiwyg.js"></script> 
<script src="../static/ace/assets/js/src/elements.spinner.js"></script> 
<script src="../static/ace/assets/js/src/elements.treeview.js"></script> 
<script src="../static/ace/assets/js/src/elements.wizard.js"></script> 
<script src="../static/ace/assets/js/src/elements.aside.js"></script> 
<script src="../static/ace/assets/js/src/ace.js"></script> 
<script src="../static/ace/assets/js/src/ace.basics.js"></script> 
<script src="../static/ace/assets/js/src/ace.scrolltop.js"></script> 
<script src="../static/ace/assets/js/src/ace.ajax-content.js"></script> 
<script src="../static/ace/assets/js/src/ace.touch-drag.js"></script> 
<script src="../static/ace/assets/js/src/ace.sidebar.js"></script> 
<script src="../static/ace/assets/js/src/ace.sidebar-scroll-1.js"></script> 
<script src="../static/ace/assets/js/src/ace.submenu-hover.js"></script> 
<script src="../static/ace/assets/js/src/ace.widget-box.js"></script> 
<script src="../static/ace/assets/js/src/ace.settings.js"></script> 
<script src="../static/ace/assets/js/src/ace.settings-rtl.js"></script> 
<script src="../static/ace/assets/js/src/ace.settings-skin.js"></script> 
<script src="../static/ace/assets/js/src/ace.widget-on-reload.js"></script> 
<script src="../static/ace/assets/js/src/ace.searchbox-autocomplete.js"></script> 

<!-- inline scripts related to this page -->

</body>
</html>
