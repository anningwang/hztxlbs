<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta charset="utf-8" />
	<title>和仲位置服务平台</title>
	<meta name="description" content="" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
	<link rel="stylesheet" href="/static/ace/assets/css/bootstrap.css" />
	<link rel="stylesheet" href="/static/ace/components/font-awesome/css/font-awesome.css" />
	<link rel="stylesheet" href="/static/ace/components/jquery.gritter/css/jquery.gritter.css" />
	<link rel="stylesheet" href="/static/ace/assets/css/ace.css" class="ace-main-stylesheet" id="main-ace-style" />
	<link rel="stylesheet" href="/static/ace/assets/css/ace-skins.css" />
	<link rel="stylesheet" href="/static/ace/assets/css/ace-rtl.css" />
	<link rel="stylesheet" href="/static/js/jquery.svg.package-1.5.0/jquery.svg.css">
	<link rel="stylesheet" href="/static/ace/components/bootstrap-datetimepicker-master/css/bootstrap-datetimepicker.min.css" />
	<link rel="stylesheet" href="/static/js/jbox/Skins2/Metro/jbox.css" />

	<script src="/static/js/jquery.min.js"></script>
	<script src="/static/ace/assets/js/ace-extra.js"></script>
	<script src="/static/js/jquery.svg.package-1.5.0/jquery.svg.js"></script>
	<script src="/static/js/socket.io-1.3.5/socket.io.min.js"></script>
	<script src="/static/js/jquery.mousewheel.js"></script>
	<script src="/static/js/jbox/jquery.jBox-2.3.min.js"></script>
	<script src="/static/js/hzlbs/hzdialog.js"></script>

	<link rel="stylesheet" href="/static/css/hzmap.css" />
	<script src="/static/js/hzlbs/hznav.js"></script>
	<script src="/static/js/hzlbs/hztools.js"></script>
	<script src="/static/js/hzlbs/hzshowmap.js"></script>

	<link rel="shortcut icon" href="/static/img/favicon.ico" />
	<link rel="bookmark" href="/static/img/favicon.ico" type="image/x-icon" />
</head>

<body class="no-skin" style="min-width: 1200px;">
<!-- #section:basics/navbar.layout -->
<div id="navbar" class="navbar navbar-default ace-save-state" style="min-width:190px;">
	<div class="navbar-container ace-save-state" id="navbar-container">
		<!-- #section:basics/sidebar.mobile.toggle -->
		<button type="button" class="navbar-toggle menu-toggler pull-left" id="menu-toggler" data-target="#sidebar"> <span class="sr-only">Toggle sidebar</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
		<!-- /section:basics/sidebar.mobile.toggle -->
		<div class="navbar-header pull-left">
			<a href="http://www.hezhongsz.com" class="navbar-brand" style="padding-top:0; padding-bottom:0;" target="_blank"> <img src="/static/img/logo.jpg" /> </a>
		</div>
		<!-- #section:basics/navbar.dropdown -->
		<div class="navbar-buttons navbar-header pull-right" role="navigation">
			<ul class="nav ace-nav">
				<!-- #section:basics/navbar.user_menu -->
				<li class="light-blue dropdown-modal"> <a data-toggle="dropdown" href="#" class="dropdown-toggle"> <img class="nav-user-photo" src="/static/ace/assets/avatars/user.jpg" alt="Jason's Photo" /> <span class="user-info"> <small>欢迎登入,</small> 欧先生 </span> <i class="ace-icon fa fa-caret-down"></i> </a>
					<ul class="user-menu dropdown-menu-right dropdown-menu dropdown-yellow dropdown-caret dropdown-close">
						<li> <a href="#"> <i class="ace-icon fa fa-cog"></i> Settings</a> </li>
						<li> <a href="#"> <i class="ace-icon fa fa-user"></i> Profile</a> </li>
						<li class="divider"></li>
						<li> <a href="#"> <i class="ace-icon fa fa-power-off"></i> Logout</a> </li>
					</ul>
				</li>
				<!-- /section:basics/navbar.user_menu -->
			</ul>
		</div>
		<!-- /section:basics/navbar.dropdown -->
	</div>
	<!-- /.navbar-container -->
</div>

<!-- /section:basics/navbar.layout -->
<div class="main-container ace-save-state" style="" id="main-container">
	<script type="text/javascript">
		try {
			ace.settings.loadState('main-container')
		}
		catch(e) {}
	</script>
	<!-- #section:basics/sidebar -->
	<div id="sidebar" class="sidebar responsive ace-save-state">
		<script type="text/javascript">
			try {
				ace.settings.loadState('sidebar')
			}
			catch(e) {}
		</script>

    <div class="sidebar-shortcuts" id="sidebar-shortcuts">
		<div class="sidebar-shortcuts-large" id="sidebar-shortcuts-large">
        <button class="btn btn-success"> <i class="ace-icon fa fa-signal"></i> </button>
        <button class="btn btn-info"> <i class="ace-icon fa fa-pencil"></i> </button>
        <!-- #section:basics/sidebar.layout.shortcuts -->
        <button class="btn btn-warning"> <i class="ace-icon fa fa-users"></i> </button>
        <button class="btn btn-danger"> <i class="ace-icon fa fa-cogs"></i> </button>
        <!-- /section:basics/sidebar.layout.shortcuts -->
		</div>
		<div class="sidebar-shortcuts-mini" id="sidebar-shortcuts-mini"> <span class="btn btn-success"></span> <span class="btn btn-info"></span> <span class="btn btn-warning"></span> <span class="btn btn-danger"></span> </div>
    </div>
    <!-- /.sidebar-shortcuts -->

    <ul class="nav nav-list" id="hz_nav"></ul>

    <!-- #section:basics/sidebar.layout.minimize -->
    <div class="sidebar-toggle sidebar-collapse" id="sidebar-collapse"> <i id="sidebar-toggle-icon" class="ace-icon fa fa-angle-double-left ace-save-state" data-icon1="ace-icon fa fa-angle-double-left" data-icon2="ace-icon fa fa-angle-double-right"></i> </div>
    <!-- /section:basics/sidebar.layout.minimize -->
	</div><!-- /section:basics/sidebar -->
	<div class="main-content">
		<div class="main-content-inner">
			<!-- #section:basics/content.breadcrumbs -->
			<!-- /section:basics/content.breadcrumbs -->
			<div class="page-content" style="padding-bottom:0;">
				<div class="row">
					<div id="myCanvas">
						<div class="" id="map_controller_panel" style="position:absolute; top:10px; left:80px; z-index:1000; width:470px;">
							<div class="btn-group btn-group-xs col-xs-12" id="map_panel_button" style="background:#FFF; border:1px solid #CCC;">
								<button type="button" class="btn btn-primary disabled"><i class="ace-icon fa fa-tag align-top bigger-125"></i>盘点区域</button>
								<button type="button" class="btn btn-primary" data-hz-target="#panelPsZoneAdd">新增</button>
								<button type="button" class="btn btn-primary" data-hz-target="#panelPsZoneChange">修改</button>
								<button type="button" class="btn btn-primary" data-hz-target="#panelPsZoneDel">删除</button>
								<button type="button" class="btn btn-primary" id="btnPsZoneShow">显示</button>
								<button type="button" class="btn btn-primary" data-hz-target="#panelPsZoneAddDefault">增加默认</button>
								<button type="button" class="btn btn-primary" id="btnPsExec">立即盘点</button>
							</div>

							<div class="map_panel_content col-xs-12" style="background:#FFF; border:1px solid #CCC;">

								<!-- 新增盘点区域 -->
								<div class="col-xs-12" style="display:none; " id="panelPsZoneAdd">
									<div class="row" style="padding-right:10px; padding-top:3px;">
										<form role="form" class="form-horizontal" id="form-validate">
											<div class="alert alert-info">新增盘点区域 <br />
											</div>
											<div class="form-group">
												<label for="inventory_name" class="col-sm-3 control-label no-padding-right">盘点名称:</label>
												<div class="col-sm-9">
													<input type="text" id="inventory_name" name="name" placeholder="" />
												</div>
											</div>
											<div class="form-group">
												<label for="psZonePeopleExpect" class="col-sm-3 control-label no-padding-right">期望人数:</label>
												<div class="col-sm-9">
													<input type="text" id="psZonePeopleExpect" name="peopleNum" placeholder="" />
												</div>
											</div>
											<div class="form-group">
												<label for="enclosure_spot_method" class="col-sm-3 control-label no-padding-right">绘制方式:</label>
												<div class="col-sm-9">
													<div class="col-xs-6">
														<select class="form-control" id="enclosure_spot_method">
															<option value="square">方形绘图</option>
															<option value="polyline">折线绘图</option>
														</select>
													</div>
													<div class="col-xs-6">
														<button type="button" id="btnDrawAddPsZone" class="btn btn-xs btn-danger"> <span>开始绘制</span> <i class="ace-icon fa fa-arrow-right icon-on-right"></i> </button>
													</div>
												</div>
											</div>
											<div class="form-group">
												<div class="col-xs-6 col-xs-push-6">
													<input type="submit" class="btn btn-success btn-xs" id="set_enclosure_submit" value="提交" />
												</div>
											</div>
										</form>
									</div>
								</div>


								<!-- 修改盘点区域 -->
								<div class="col-xs-12" style="display:none;" id="panelPsZoneChange">
									<div class="row" style="padding-right:10px; padding-top:3px;">
										<form role="form" class="form-horizontal" id="form-validate2">
											<div class="alert alert-info">修改盘点区域<br />
											</div>
											<div class="form-group">
												<label for="alter_enclosure_name" class="col-sm-3 control-label no-padding-right">修改的区域:</label>
												<div class="col-sm-9">
													<select class="form-control" id="alter_enclosure_name" name="name"></select>
												</div>
											</div>

											<div class="form-group">
												<label for="enclosure_new_name" class="col-sm-3 control-label no-padding-right">区域名称:</label>
												<div class="col-sm-9">
													<input type="text" id="enclosure_new_name" name="name" placeholder="不填为不修改!" />
												</div>
											</div>

											<div class="form-group">
												<label for="enclosure_new_name" class="col-sm-3 control-label no-padding-right">期望人数:</label>
												<div class="col-sm-9">
													<input type="text" id="enclosure_new_expectNum" name="name" placeholder="不填为不修改!" />
												</div>
											</div>


											<div class="form-group">
												<label for="enclosure_spot_method2" class="col-sm-3 control-label no-padding-right">绘制方式:</label>
												<div class="col-sm-9">
													<div class="col-xs-6">
														<select class="form-control" id="enclosure_spot_method2">
															<option value="square">方形绘图</option>
															<option value="polyline">折线绘图</option>
														</select>
													</div>
													<div class="col-xs-6">
														<button type="button" id="btnDrawChangePsZone" class="btn btn-xs btn-danger"> <span>开始绘制</span> <i class="ace-icon fa fa-arrow-right icon-on-right"></i> </button>
													</div>
												</div>
											</div>
											<div class="form-group">
												<div class="col-xs-6 col-xs-push-6">
													<input type="submit" class="btn btn-success btn-xs" id="btnChangePsZone" value="提交" />
												</div>
											</div>
										</form>
									</div>
								</div>

								<!-- 删除盘点区域 -->
								<div class="col-xs-12" style="display:none;" id="panelPsZoneDel">
									<div class="row" style="padding-right:10px; height:200px; padding-top:3px;">
										<form role="form" class="form-horizontal" id="form-validate3">
											<div class="alert alert-info">删除盘点区域 <br />
											</div>

											<div class="form-group" id="enclosure_item">

											</div>
											<div class="form-group">
												<div class="col-xs-6 col-xs-push-6">
													<button type="button" class="btn btn-success btn-xs" id="enclosure_item_button">删除</button>
												</div>
											</div>
										</form>
									</div>
								</div>

								<div class="col-xs-12" style="display:none;" id="panelPsZoneAddDefault">
									<div class="row" style="padding-right:10px; padding-top:3px; padding-bottom:20px;">
										<div class="alert alert-info">增加默认盘点区域 <br /></div>
										<button id="btnAddPsZoneDefault" class="col-lg-12 btn btn-info">增加</button>
									</div>
								</div>
							</div>
						</div>
						<div id="gritter-notice-wrapper" style="position:absolute; right:0; z-index:1001;"></div>


					</div>
				</div>

				<!--页脚-->
				<div class="footer">
					<div class="footer-inner " >
						<!-- #section:basics/footer -->
						<div class="footer-content "> <span class="bigger-120"> 衡阳市和仲通讯科技有限公司 &copy; 2016-2018 </span> &nbsp; &nbsp; <span class="action-buttons"> <a href="#"> <i class="ace-icon fa fa-twitter-square light-blue bigger-150"></i> </a> <a href="#"> <i class="ace-icon fa fa-facebook-square text-primary bigger-150"></i> </a> <a href="#"> <i class="ace-icon fa fa-rss-square orange bigger-150"></i> </a> </span> </div>
						<!-- /section:basics/footer -->
					</div>
				</div>
			</div>  <!-- /.page-content -->

		</div>
	</div> <!-- /.main-content -->
</div> <!-- /.main-container -->

<script>
	'use strict';


	$(function () {
		var ps_zone_data = undefined;		// 盘点区域临时数据
		var global_init = new Init();
		var boardLayer = $('#svg-people-stat-zone-draft');

		/**
		 * 显示盘点结果
		 */
		function showPsResult(data) {
			console.log('showPsResult', data);
			if (data.errorCode !== 0) return;
			var psRec = data['statInfo'];
			if (psRec.length == 0) return;
			var text = '编号['+ psRec[0]['statNo'] +'] 盘点时间[' + psRec[0]['datetime'] + ']<br>';

			for(var i=0; i< psRec.length; i++) {
				if (psRec[i]['curPeopleNum'] > 0) {
					text += '区域[' + psRec[i]['roomName'] + ']  人数[' + psRec[i]['curPeopleNum'] + ']  期望人数[' + psRec[i]['expectNum'] + ']<br>'
				}
			}
			text += '其他区域，盘点人数为：0';

			$.gritter.add({
				title: '盘点结果',
				text: text,
				class_name: 'gritter-info',
				image: '/static/img/redImageMarker.png',
				sticky: true,
				time: ''
			});
		}

		// svg地图 控制面板
		$("#map_panel_button").find('button').on('click', function () {
			var btn = $(this);

			// added by wxg 2018-01-02
			if (btn.attr('id') === 'btnPsZoneShow'){
				if(btn.text() === '隐藏') {	// 隐藏 盘点区域
					btn.text('显示');
					clearPsZone();
				} else {	// 显示 盘点区域
					btn.text('隐藏');
					showPsZone();
				}
				return;
			} else if (btn.attr('id') === 'btnPsExec'){
				psExec({showMsg: false, callback: showPsResult });
				return;
			}

			if(btn.hasClass('active')) {
				map_button_slide_up(btn);
			} else {
				map_button_slide_down(btn)
			}
		});


		function map_button_slide_down($this) {
			$this.addClass('active');
			$this.siblings().removeClass('active');
			var $target = $($this.attr('data-hz-target'));
			$target.siblings().slideUp('100', function () {
				$target.slideDown();
			})
		}

		function map_button_slide_up($this) {
			$this.removeClass('active');
			var $target = $($this.attr('data-hz-target'));
			$target.slideUp();
		}


		//var psZoneAdd = new HzDrawTools();
		var psZoneAdd = new HzDrawZone({board: boardLayer, penColor:'blue'});

		function changeTextPsZoneAdd($this){
			var $span = $this.find('span');
			var buttonText = $span.text();
			var shape = $('#enclosure_spot_method');
			if(shape.val() === 'polyline') {
				if(buttonText === '清空绘制') {
					$span.text('开始绘制');
					shape.removeAttr('disabled');
				} else {
					$span.text('清空绘制');
					shape.attr('disabled', 'disabled');
				}
			}

			// 方形绘图
			if(shape.val() === 'square') {
				if(buttonText === '清空绘制') {
					$span.text('开始绘制');
					shape.removeAttr('disabled');
				} else {
					$span.text('清空绘制');
					shape.attr('disabled', 'disabled');
				}
			}
		}

		$("#btnDrawAddPsZone").on('click', function () {
			var $this = $(this);
			var $span = $this.find('span');
			var buttonText = $span.text();
			var $method_select = $('#enclosure_spot_method');
			if($method_select.val() === 'polyline') {

				if(buttonText === '清空绘制') {
					global_init.run();
				} else {
					$span.text('清空绘制');
					global_init.run();
					global_init.add(psZoneAdd,psZoneAdd.remove_event);
					global_init.add(changeTextPsZoneAdd,$this);
					$method_select.attr('disabled', 'disabled');
					psZoneAdd.polyline();
				}
			}
			// 方形绘图
			if($method_select.val() === 'square') {
				if(buttonText === '清空绘制') {
					global_init.run();
				} else {
					$span.text('清空绘制');
					global_init.run();
					global_init.add(psZoneAdd,psZoneAdd.remove_square);
					global_init.add(changeTextPsZoneAdd,$this);
					$method_select.attr('disabled', 'disabled');
					psZoneAdd.square();
				}
			}
		});

		// var psZoneChange = new HzDrawTools();
		var psZoneChange = new HzDrawZone({board: boardLayer, penColor:'blue'});

		function changeTextPsZoneChange($this){
			var $span = $this.find('span');
			var buttonText = $span.text();
			var $method_select = $('#enclosure_spot_method2');
			if($method_select.val() === 'polyline') {
				if(buttonText === '清空绘制') {
					$span.text('开始绘制');
					$method_select.removeAttr('disabled');
				} else {
					$span.text('清空绘制');
					$method_select.attr('disabled', 'disabled');
				}
			}

			// 方形绘图
			if($method_select.val() === 'square') {
				if(buttonText === '清空绘制') {
					$span.text('开始绘制');
					$method_select.removeAttr('disabled');
				} else {
					$span.text('清空绘制');
					$method_select.attr('disabled', 'disabled');
				}
			}
		}

		$("#btnDrawChangePsZone").on('click', function () {
			var $this = $(this);
			var $span = $this.find('span');
			var buttonText = $span.text();
			var $method_select = $('#enclosure_spot_method2');
			if($method_select.val() === 'polyline') {
				if(buttonText === '清空绘制') {
					global_init.run();
				} else {
					$span.text('清空绘制');
					global_init.run();
					global_init.add(psZoneChange,psZoneChange.remove_event);
					global_init.add(changeTextPsZoneChange,$this);
					$method_select.attr('disabled', 'disabled');
					psZoneChange.polyline();
				}
			}
			// 方形绘图
			if($method_select.val() === 'square') {
				if(buttonText === '清空绘制') {
					global_init.run();
				} else {
					$span.text('清空绘制');
					global_init.run();
					global_init.add(psZoneChange,psZoneChange.remove_square);
					global_init.add(changeTextPsZoneChange,$this);
					$method_select.attr('disabled', 'disabled');
					psZoneChange.square();
				}
			}
		});


		$('#btnAddPsZoneDefault').click(function(){
			ajaxJsonRequest({
				url: '/lbs/people_stat_cfg_add_default',
				txData: {},
				callback: function (data) {
					hzInfo(data.msg);
				}
			});
			showPsZone();
		});

		// 修改盘点区域
		$('#btnChangePsZone').on('click', function () {
			var oName = $('#alter_enclosure_name');
			var psZoneId = oName.val();
			var enclosure_new_expectNum = $('#enclosure_new_expectNum').val();
			var psZoneOldName = oName.find("option:selected").text();
			var psZoneNewName = $('#enclosure_new_name').val();

			var psZoneChange_points = psZoneChange.points;

			console.log('psZoneChange_points', psZoneChange_points);
			if(psZoneId == 'undefined') {
				hzInfo('该盘点区域不能修改!');
				return false;
			}

			if(psZoneId == 0) {
				hzInfo('请选择盘点区域!');
				return false;
			}
			if(psZoneChange.points.length > 0 && psZoneChange.points[0] != psZoneChange.points[psZoneChange.points.length - 1]) {
				hzInfo('您没有画图');
				return false;
			}

			var pointsToServer = [];

			var points_length = psZoneChange_points.length - 1;
			for(var i = 0; i < points_length; i++) {
				var pt = {
					x: coordScreenToMap(psZoneChange.points[i][0]),
					y: coordScreenToMap(psZoneChange.points[i][1])
				};
				pointsToServer.push(pt);
			}

			var data = {
				id: parseInt(psZoneId)
			};

			if(psZoneNewName == '') {
				data.name = psZoneOldName;
			} else {
				data.name = psZoneNewName;
			}

			if(enclosure_new_expectNum != ''){
				data.expectNum = enclosure_new_expectNum;
			}

			if (pointsToServer.length > 0)
				data.points = pointsToServer;

			console.log('btnChangePsZone, send data=', data);
			ajaxJsonRequest({
				url: '/lbs/people_stat_cfg_chg',
				txData: [data],
				callback: function () {
					query_electronic();
					$('#btnDrawChangePsZone').click();
					showPsZone();
					hzInfo(result.msg);
				}
			});
		});

		(function (factory) {
			if(typeof define === "function" && define.amd) {
				define(["jquery", ""], factory);
			}
			else {
				factory(jQuery);
			}
		}(function ($) {
			/*
			 * Translated default messages for the jQuery validation plugin.
			 * Locale: ZH (Chinese, 中文, 汉语, 漢語)
			 */
			$.extend($.validator.messages, {
				required: "这是必填字段",
				remote: "请修正此字段",
				email: "请输入有效的电子邮件地址",
				url: "请输入有效的网址",
				date: "请输入有效的日期",
				dateISO: "请输入有效的日期 (YYYY-MM-DD)",
				number: "请输入有效的数字",
				digits: "只能输入数字",
				creditCard: "请输入有效的信用卡号码",
				equalTo: "你的输入不相同",
				extension: "请输入有效的后缀",
				maxLength: $.validator.format("最多可以输入 {0} 个字符"),
				minLength: $.validator.format("最少要输入 {0} 个字符"),
				rangeLength: $.validator.format("请输入长度在 {0} 到 {1} 之间的字符串"),
				range: $.validator.format("请输入范围在 {0} 到 {1} 之间的数值"),
				max: $.validator.format("请输入不大于 {0} 的数值"),
				min: $.validator.format("请输入不小于 {0} 的数值")
			});
		}));


		$('#form-validate').validate({
			errorElement: 'div',
			errorClass: 'help-block',
			focusInvalid: false,
			ignore: "",
			rules: {
				name: {
					required: true
				},
				peopleNum: {
					digits: true
				}
			},

			highlight: function (e) {
				$(e).closest('.form-group').removeClass('has-info').addClass('has-error');
			},

			success: function (e) {
				$(e).closest('.form-group').removeClass('has-error'); //.addClass('has-info');
				$(e).remove();
			},


			submitHandler: function (form) {
				if(psZoneAdd.points[0] == undefined || psZoneAdd.points[0] != psZoneAdd.points[psZoneAdd.points.length - 1]) {
					hzInfo('您没有画图');
					return;
				}

				var $form = $(form);
				var data = {
					name: $form.find("#inventory_name").val()
				};

				var peopleNum = $form.find("#psZonePeopleExpect").val();
				if(peopleNum) {
					data.expectNum = parseInt(peopleNum);
				}

				var points = [];
				var points_length = psZoneAdd.points.length - 1;
				for(var i = 0; i < points_length; i++) {
					var pt = {
						x: coordScreenToMap(psZoneAdd.points[i][0]),
						y: coordScreenToMap(psZoneAdd.points[i][1])
					};
					points.push(pt);
				}
				data.points = points;

				$('#btnDrawAddPsZone').click();
				console.log('submitHandler send data=', data);

				ajaxJsonRequest({
					url: '/lbs/people_stat_cfg_add',
					txData: { data: [data] },
					callback: function (data) {
						query_electronic();
						showPsZone();
						hzInfo(data.msg);
					}
				});
			},
			invalidHandler: function (form) {}
		});

		function query_electronic(){
			var url = '/lbs/people_stat_cfg_get';
			var txData = {
				rows:200
			};
			ajaxJsonRequest({
				url: url,
				txData: txData,
				callback: function (data) {
					var dataData = data.data.rows;
					var dataDataLength = dataData.length;
					var selectHtml = '<option value="0">请选择盘点区域</option>';
					var checkboxHtml = '';
					for (var i = 0; i<dataDataLength; i++){
						selectHtml += '<option value="'+dataData[i].id+'">'+dataData[i].name+'</option>';
						if(dataData[i].id != undefined){
							checkboxHtml += '<div class="col-xs-6"><div class="ace-settings-item"><input type="checkbox" class="ace ace-checkbox-2 ace-save-state" id="ace-settings-navbar-' + i + '" autocomplete="off" value="'+dataData[i].id+'" /><label class="lbl" for="ace-settings-navbar-'+i+'">'+dataData[i].name+'</div></div>'}
					}
					$('#alter_enclosure_name').html(selectHtml);
					$('#enclosure_item').html(checkboxHtml);
				}
			});
		}

		query_electronic();

		$('#enclosure_item_button').on('click',function(){
			var $enclosure_item = $('#enclosure_item');
			var items = $enclosure_item.find(':checked');

			global_init.run();

			if(items == undefined){
				hzInfo('请选择要删除的盘点区域!');
				return false;
			}
			var ids = [];
			items.each(function(){
				ids.push($(this).val());
			});

			var url = '/lbs/hz_data_del';
			var data = {
				who:'people_stat_cfg',
				ids:ids
			};
			console.log('enclosure_item_button send data:',data);
			ajaxJsonRequest({
				url: url,
				txData: data,
				callback: function (data) {
					query_electronic();
					showPsZone();
					hzInfo(data.msg);
				}
			});
		});


		$('#electronic-fence-query-button').click(function () {
			global_init.run();
			showPsZone();
		});

		// 盘点区域查询缩放附加函数
		function draw_ps_zone_fn() {
			drawPsZone(ps_zone_data);
		}

		function showPsZone() {
			if ($('#btnPsZoneShow').text() !== '隐藏') return;

			var url = '/lbs/people_stat_cfg_get';
			var txData = {
				"floorNo": 'Floor3',
				rows: 100
			};
			ajaxJsonRequest({
				url: url,
				txData: txData,
				callback: function (data) {
					ps_zone_data = data.data.rows;
					drawPsZone(ps_zone_data);
					addZoomCallback(draw_ps_zone_fn);
				}
			});
		}

		function clearPsZone (){
			ps_zone_data = [];
			delZoomCallback(draw_ps_zone_fn);

			var draw_path = $('#svg-people-stat-zone');
			var svg = draw_path.svg('get');
			svg.clear();
		}


		function drawPsZone(data) {
			console.log('drawPsZone',data);
			var erBoard = $('#svg-people-stat-zone');
			erBoard.svg();
			var svg = erBoard.svg('get');
			svg.clear();

			for(var k = 0; k < data.length; k++) {
				var pts = data[k].points;
				var pointsScreen = [];
				var ptArr;

				for(var i = 0; i < pts.length; i++) {
					ptArr = [];
					ptArr.push(coordMapToScreen(pts[i].x));
					ptArr.push(coordMapToScreen(pts[i].y));
					pointsScreen.push(ptArr);
				}

				// 再次增加第一个画线起点
				ptArr = [];
				ptArr.push(coordMapToScreen(pts[0].x));
				ptArr.push(coordMapToScreen(pts[0].y));
				pointsScreen.push(ptArr);

				svg.polyline(pointsScreen, {
					fill: 'DeepSkyBlue',
					opacity: 0.6,
					stroke: 'blue',
					strokeWidth: 5
				});

				svg.text(coordMapToScreen(pts[0].x) + 10, coordMapToScreen(pts[0].y) + 20, data[k].name, {
					fontSize: 14,
					fontFamily: 'Verdana',
					fill: 'RoyalBlue'
				});
			}
		}

		var socket = io.connect(hz_connStr);
		socket.on('hz_position', function(msg) {
			console.log('hz_position', msg);
			for (var i=0; i<msg.length; i++){
				hzPeopleGoto(msg[i]['x'], msg[i]['y'], msg[i]['userId']);
			}
		});

		// 默认显示 盘点区域
		$('#btnPsZoneShow').click();

	})
</script>

<script type="text/javascript">
	if('ontouchstart' in document.documentElement) document.write("<script src='/static/ace/components/_mod/jquery.mobile.custom/jquery.mobile.custom.js'>" + "<" + "/script>");
</script>
<script src="/static/ace/components/bootstrap/dist/js/bootstrap.js"></script>
<script src="/static/ace/components/bootstrap-datetimepicker-master/js/bootstrap-datetimepicker.min.js"></script>
<script src="/static/ace/components/jquery.gritter/js/jquery.gritter.js"></script>
<script src="/static/ace/components/jquery-validation/dist/jquery.validate.js"></script>

<script src="/static/ace/assets/js/src/elements.scroller.js"></script>
<script src="/static/ace/assets/js/src/elements.colorpicker.js"></script>
<script src="/static/ace/assets/js/src/elements.fileinput.js"></script>
<script src="/static/ace/assets/js/src/elements.typeahead.js"></script>
<script src="/static/ace/assets/js/src/elements.wysiwyg.js"></script>
<script src="/static/ace/assets/js/src/elements.spinner.js"></script>
<script src="/static/ace/assets/js/src/elements.treeview.js"></script>
<script src="/static/ace/assets/js/src/elements.wizard.js"></script>
<script src="/static/ace/assets/js/src/elements.aside.js"></script>
<script src="/static/ace/assets/js/src/ace.js"></script>
<script src="/static/ace/assets/js/src/ace.basics.js"></script>
<script src="/static/ace/assets/js/src/ace.scrolltop.js"></script>
<script src="/static/ace/assets/js/src/ace.ajax-content.js"></script>
<script src="/static/ace/assets/js/src/ace.touch-drag.js"></script>
<script src="/static/ace/assets/js/src/ace.sidebar.js"></script>
<script src="/static/ace/assets/js/src/ace.sidebar-scroll-1.js"></script>
<script src="/static/ace/assets/js/src/ace.submenu-hover.js"></script>
<script src="/static/ace/assets/js/src/ace.widget-box.js"></script>
<script src="/static/ace/assets/js/src/ace.settings.js"></script>
<script src="/static/ace/assets/js/src/ace.settings-rtl.js"></script>
<script src="/static/ace/assets/js/src/ace.settings-skin.js"></script>
<script src="/static/ace/assets/js/src/ace.widget-on-reload.js"></script>
<script src="/static/ace/assets/js/src/ace.searchbox-autocomplete.js"></script>

</body>
</html>
